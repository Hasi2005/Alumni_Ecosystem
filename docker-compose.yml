name: alumni-student-suite

services:
  mysql-auth:
    image: mysql:8.0
    container_name: mysql-auth
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      MYSQL_DATABASE: security_db
    ports:
      - "${AUTH_DB_HOST_PORT:-3310}:3306"
    command: [
      "--default-authentication-plugin=mysql_native_password",
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_unicode_ci"
    ]
    volumes:
      - mysql_auth_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD:-jyothi}"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - backend

  mysql-mentorship:
    image: mysql:8.0
    container_name: mysql-mentorship
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      MYSQL_DATABASE: mentorship
    ports:
      - "${MENTORSHIP_DB_HOST_PORT:-3311}:3306"
    command: [
      "--default-authentication-plugin=mysql_native_password",
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_unicode_ci"
    ]
    volumes:
      - mysql_mentorship_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD:-jyothi}"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - backend

  mysql-job:
    image: mysql:8.0
    container_name: mysql-job
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      MYSQL_DATABASE: job_service_db
    ports:
      - "${JOB_DB_HOST_PORT:-3312}:3306"
    command: [
      "--default-authentication-plugin=mysql_native_password",
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_unicode_ci"
    ]
    volumes:
      - mysql_job_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD:-jyothi}"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - backend

  mysql-referral:
    image: mysql:8.0
    container_name: mysql-referral
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      MYSQL_DATABASE: referral_service_db
    ports:
      - "${REFERRAL_DB_HOST_PORT:-3313}:3306"
    command: [
      "--default-authentication-plugin=mysql_native_password",
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_unicode_ci"
    ]
    volumes:
      - mysql_referral_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD:-jyothi}"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - backend

  mysql-fund:
    image: mysql:8.0
    container_name: mysql-fund
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      MYSQL_DATABASE: fund_db
    ports:
      - "${FUND_DB_HOST_PORT:-3314}:3306"
    command: [
      "--default-authentication-plugin=mysql_native_password",
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_unicode_ci"
    ]
    volumes:
      - mysql_fund_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD:-jyothi}"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - backend

  auth-service:
    build: ./auth-service/auth-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-auth:3306/security_db?useSSL=false&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    ports:
      - "${AUTH_HOST_PORT:-8081}:8081"
    depends_on:
      mysql-auth:
        condition: service_healthy
    networks:
      - backend

  mentorship-service:
    build: ./mentorship_service/mentorship_service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-mentorship:3306/mentorship?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      AUTH_INTERNAL_BASE_URL: http://auth-service:8081
      AUTH_PUBLIC_BASE_URL: http://localhost:${AUTH_HOST_PORT:-8081}
    ports:
      - "${MENTORSHIP_HOST_PORT:-8082}:8082"
    depends_on:
      mysql-mentorship:
        condition: service_healthy
    networks:
      - backend

  job-service:
    build: ./job_service/job_service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-job:3306/job_service_db?useSSL=false&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      AUTH_INTERNAL_BASE_URL: http://auth-service:8081
      AUTH_PUBLIC_BASE_URL: http://localhost:${AUTH_HOST_PORT:-8081}
      REFERRAL_PUBLIC_BASE_URL: http://localhost:${REFERRAL_HOST_PORT:-8084}
    ports:
      - "${JOB_HOST_PORT:-8083}:8083"
    depends_on:
      mysql-job:
        condition: service_healthy
    networks:
      - backend

  referral-service:
    build: ./referral_service/referral_service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-referral:3306/referral_service_db?useSSL=false&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      AUTH_INTERNAL_BASE_URL: http://auth-service:8081
      AUTH_PUBLIC_BASE_URL: http://localhost:${AUTH_HOST_PORT:-8081}
      JOB_PUBLIC_BASE_URL: http://localhost:${JOB_HOST_PORT:-8083}
      JOB_INTERNAL_BASE_URL: http://job-service:8083
    ports:
      - "${REFERRAL_HOST_PORT:-8084}:8084"
    depends_on:
      mysql-referral:
        condition: service_healthy
    networks:
      - backend

  fund-allocation:
    build: ./fund_allocation2/fund_allocation2
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-fund:3306/fund_db?useSSL=false&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-jyothi}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      AUTH_INTERNAL_BASE_URL: http://auth-service:8081
      AUTH_PUBLIC_BASE_URL: http://localhost:${AUTH_HOST_PORT:-8081}
    ports:
      - "${FUND_HOST_PORT:-8080}:8080"
    depends_on:
      mysql-fund:
        condition: service_healthy
    networks:
      - backend

volumes:
  mysql_auth_data:
  mysql_mentorship_data:
  mysql_job_data:
  mysql_referral_data:
  mysql_fund_data:

networks:
  backend:
    driver: bridge
